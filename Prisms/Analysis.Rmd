---
title: "Spatial WM and Tempral Estimation with Prisms in Neglect"
author: "Jason Locklin <jalockli@uwaterloo.ca>"
output:
  html_document:
    fig_caption: yes
    keep_md: yes
    toc: yes
---


Basic Analysis
========================================================

This documents the analysis. 

## Loading the data and libraries

```{r}
library(plyr)
library(ggplot2)
TE  <- read.csv("Data/TE.tsv", sep="\t")
SWM <- read.csv("Data/SWM.csv")
NT  <- read.csv("Data/Neglect_tests.csv", na.strings="")
LB  <- read.csv("Data/Line_Bisection_task.csv", sep="\t")
```

### Looking at TE first

```{r}
summary(TE)
```

Fixing the factors and simplifying (note that TrialDuration is both a factor 
and quantitative variable, going with factor for ease of plotting):
```{r}
TE$Subject <- factor(TE$Subject)
TE$Session <- factor(TE$Session)
TE$Block <- factor(TE$Block)
TE$TrialDuration <- factor(TE$TrialDuration)
TE <- data.frame(TE$Subject, TE$Session, TE$SessionDate, TE$Block, 
                 TE$Response.RESP, TE$TrialDuration)
names(TE) <- c("Subject", "Session", "Date", "Block", "Response", "TrialDuration")
TE$Prisms <- factor( as.numeric(TE$Session) > 1)
levels(TE$Prisms) <- c("pre", "post")
```

And now:
```{r}
summary(TE)
```

### Spatial Working Memory (SWM)
```{r}
summary(SWM)
```

RT was entered by the experimentor, so is not useful in analysis. Extremely long 
RT trials should be removed, though, because they were likely a result of the 
participant taking a break or chatting with the experimentor. RTs of more than
6 seconds are very unlikely to have been trials where the participant provided a
attended response. 
```{r}
quantile(SWM$RT, probs = c(0.75, 0.85, 0.90, 0.925, 0.95, 0.975, 0.99))
SWM <- SWM[SWM$RT < 6000,]
```



Data frame Cleanup:
```{r}
levels(SWM$Pre.Post) <- c("post", "pre", "pre", "pre")
SWM <- data.frame(SWM$Subject, SWM$Pre.Post, SWM$Trial.., SWM$Key, SWM$Trial.Type)
names(SWM) <- c("Subject", "Prisms", "Trial", "Resp", "Trial.Type")
```

We need to calculate another factor indicating whether each trial is a True 
positive, a false positive, a true negative, or a false negative.
```{r}
Resp.Type <- rep("NONE", length(SWM$Resp))
Resp.Type[SWM$Resp == "SP" & SWM$Trial.Type == "Valid"]   <- "TP"
Resp.Type[SWM$Resp == "CR" & SWM$Trial.Type == "Valid"]   <- "FN"
Resp.Type[SWM$Resp == "SP" & SWM$Trial.Type == "Invalid"] <- "FP"
Resp.Type[SWM$Resp == "CR" & SWM$Trial.Type == "Invalid"] <- "TN"
SWM$Resp.Type <- factor(Resp.Type)
SWM$Hit <- factor(Resp.Type == "TP")
SWM$FalseAlarm <- factor(Resp.Type == "FP")
rm(Resp.Type)
```

The final result:
```{r}
summary(SWM)
```

### Line Bisection
```{r}
summary(LB)
```

Setting the correct factors and better names:
```{r}
LB$sj <- factor(LB$sj)
LB$sess <- factor(LB$sess)
LB$prisms <- factor(LB$prisms)
levels(LB$prisms) <- c("pre","post")
names(LB) <- c("Subject", "Session", "Prisms", "Percent_Error")
summary(LB)
```

**Note that session numbers won't line up with other datasets as some participants
did multiple pre-prisms line bisection tasks.



### Other Neglect Tests

```{r}
summary(NT)
```

```{r}
NT$Subject <- factor(NT$Subject)
NT$Session <- factor(NT$Session)
levels(NT$Star_Prisms) <- c("no", "no", "yes")
NT$Star_Prisms[is.na(NT$Star_L_Omissions) & is.na(NT$Star_R_Omissions)] <- NA
NT$Bell_Prisms[is.na(NT$Bell_L_omissions) & is.na(NT$Bell_R_Omissions)] <- NA
NT$Bell_L_omissions <- as.numeric(as.character(NT$Bell_L_omissions))
NT$Bell_R_Omissions <- as.numeric(as.character(NT$Bell_R_Omissions))
```

## Plotting TE

TE: For each SJ, for each Session, for each Duration, median response bias.
      *Note:* create a "Prisms" factor from Session Number. 

Table of values for group:

```{r}
ddply(TE, .(Prisms, TrialDuration), summarize, 
      mean = round( mean(Response, na.rm=TRUE), 0),
      sd =  round( sd(Response, na.rm=TRUE), 0))
```

As we expected, participants massively underestimate time intervals. The 
underestimation seems to be proportional to the trial duration in some way though.

* Note the high variance in the pre/5second block -check for issues in the data.

* Everywhere else, the sd is close-to or less than the response.

* There is no obvious change in means after prisms, but the increased variance may
  indicate differing responses among participants.

Considering just those 5 second trials:
```{r}
ddply(TE[TE$TrialDuration==5,], .(Subject, Session, Prisms), summarize, 
      mean = round( mean(Response, na.rm=TRUE), 0),
      sd =  round( sd(Response, na.rm=TRUE), 0))
```

The high variance is coming entirely from participant 171.
```{r}
ddply(TE[TE$Subject==171,], .(Session, Prisms, TrialDuration), summarize, 
      mean = round( mean(Response, na.rm=TRUE), 0),
      sd =  round( sd(Response, na.rm=TRUE), 0))
TE[TE$Subject==171 & TE$TrialDuration == 5 & TE$Session == 1,]
```

The participant's dataset looks completely reasonable, with the particular 
exception of 5 second trials in the pre-prisms phase. Looking at the four trials
concerned, a single response of 99 seems to have been entered. I belive the 
experimentor entered 99 to indicate a no-response. Looking for other '99's, and
removing them:
```{r}
TE[TE$Response == 99,]
TE <- TE[TE$Response != 99 & !is.na(TE$Response),]
```

Now, looking at the dataset again, it looks better:
```{r}
ddply(TE, .(Prisms, TrialDuration), summarize, 
      mean = round( mean(Response, na.rm=TRUE), 0),
      sd =  round( sd(Response, na.rm=TRUE), 0))
```

I suspect that the participant bias is linearly proportional to trial durration,

```{r TE_full, fig.width=12, cache=FALSE}
TE2 <- ddply(TE[as.numeric(TE$Session) < 3 ,], .(Subject, Session, Prisms, TrialDuration), 
             summarize, Response = round( median(Response, na.rm=TRUE), 0) )
TE2$TrialDuration <- as.numeric(as.character(TE2$TrialDuration)) #switch to numeric
TE2$Session <- factor(TE2$Session) #Fix levels

p <- ggplot(data = TE2, aes(x = TrialDuration, 
                           y = Response, group = Subject))

p +  geom_line() + scale_x_continuous(breaks=c(5,15,30,60)) +
  scale_y_continuous(breaks=c(5,15,30,60)) +
  stat_smooth(aes(group = 1), method = "glm", formula = y ~ log(x)) + 
  facet_grid(. ~ Prisms) + ggtitle("Temporal Estimation")
```

Wow. Subject 27 was not at all like the others -performing aproximately 
accurately. Note that the blue line and associated band are a t-based aproximation
of the true mean and a 95 percent confidence interval around that. 

Let's look at it without him:

```{r TE_zoom, fig.width=12, cache=FALSE}
TE2 <- ddply(TE[as.numeric(TE$Session) < 3 & TE$Subject != "27",],
             .(Subject, Session, Prisms, TrialDuration), 
             summarize, Response = round( median(Response, na.rm=TRUE), 0) )
TE2$TrialDuration <- as.numeric(as.character(TE2$TrialDuration)) #switch to numeric
TE2$Session <- factor(TE2$Session) #Fix levels

p <- ggplot(data = TE2, aes(x = TrialDuration, 
                           y = Response, group = Subject))

p +  geom_line() + scale_x_continuous(breaks=c(5,15,30,60)) +
  scale_y_continuous(breaks=c(5,15,30,60)) +
  stat_smooth(aes(group = 1), method = "glm", formula = y ~ log(x)) + 
  facet_grid(. ~ Prisms) 
```

The general trend seems to be somewhat of a quadratic relationship between
response and trial duration, but looking at the individual participant lines,
a linear aproximation wouldn't be terrible -if we wanted to keep it simple and 
talk about response bias as a percent of total trial time.

```{r TE_proportion, fig.width=12, cache=FALSE}
TE$PercentBias <- round(((TE$Response - as.numeric(as.character(TE$TrialDuration))) 
                                    / as.numeric(as.character(TE$TrialDuration))
                         )*100, 0)
TE2 <- ddply(TE, .(Subject, Session, Prisms), summarize, 
      Percent = round( mean(PercentBias, na.rm=TRUE), 0),
      sd =  round( sd(PercentBias, na.rm=TRUE), 0))
TE2

p <- qplot(data = TE2, x=Session, y=Percent, geom="bar", stat="identity", 
       fill=Prisms, width = 0.8) + facet_wrap(~ Subject)
p + scale_fill_brewer(type="qual", palette=3)
rm(p, TE2)
```

So, all partipants start with an underestimate across the board, but change is
heterogenious. Should probably add some sort of error bars, but will have to think
about the best way to calculate them considering the data.

## Analysing TE

All analysis should be done with, and without subject 27, as this participant
was not neglecting and obviously distinct.


```{r}
TE2 <- ddply(TE,
             .(Subject, Prisms, TrialDuration), 
             summarize, Response = round( median(Response, na.rm=TRUE), 0) )
TE2$TrialDuration <- as.numeric(as.character(TE2$TrialDuration)) #switch to numeric
require(tidyr)

# Anova: resp ~ Prisms + Duration
# Duration is really a random variable.
require(ez)
model <- ezANOVA(TE2, wid=Subject,
        dv=.(Response), within=.(Prisms), within_covariates=TrialDuration)
print(model)

#without ANCOVA
TE2$TrialDuration <- factor(TE2$TrialDuration)
model <- ezANOVA(TE2, wid=Subject,
        dv=.(Response), within=.(Prisms, TrialDuration))
print(model)

TE3 <- spread(TE2, Prisms, Response)
for(i in c(5,15,30,60) ){ 
  print(i)
  tmp <- TE3[TE3$TrialDuration == i,]
  print( t.test(tmp$pre, tmp$post, paired=TRUE) )
  }




```


Now the Above, without participant 27
```{r}
TE2 <- ddply(TE[TE$Subject != "27",],
             .(Subject, Prisms, TrialDuration), 
             summarize, Response = round( median(Response, na.rm=TRUE), 0) )
TE2$TrialDuration <- as.numeric(as.character(TE2$TrialDuration)) #switch to numeric
require(tidyr)

# Anova: resp ~ Prisms + Duration
# Duration is really a random variable.
require(ez)
model <- ezANOVA(TE2, wid=Subject,
        dv=.(Response), within=.(Prisms), within_covariates=TrialDuration)
print(model)

#without ANCOVA
TE2$TrialDuration <- factor(TE2$TrialDuration)
model <- ezANOVA(TE2, wid=Subject,
        dv=.(Response), within=.(Prisms, TrialDuration))
print(model)

TE3 <- spread(TE2, Prisms, Response)
for(i in c(5,15,30,60) ){ 
  print(i)
  tmp <- TE3[TE3$TrialDuration == i,]
  print( t.test(tmp$pre, tmp$post, paired=TRUE) )
  }
```


## Plotting SWM

* SWM: For each SJ, for each Prisms, calculate some measure of Signal detection.

Table of responses:
```{r}
ddply(SWM, .(Subject, Prisms), summarise, 
      True_Positives = sum(as.numeric(Resp.Type == "TP")  ),
      False_Positives = sum(as.numeric(Resp.Type == "FP")  ),
      True_Negatives = sum(as.numeric(Resp.Type == "TN")  ),
      False_Negatives = sum(as.numeric(Resp.Type == "FN")  ) )
```
All participants made more True than False responses, both before and after
prisms, and for valid and invalid trials. They must have been paying at attention
to some degree.


```{r}
SWM2 <- ddply(SWM, .(Subject, Prisms), summarise, 
      Hits = sum(as.numeric(Hit) - 1 ),
      FalseAlarms = sum(as.numeric(FalseAlarm) -1),
      H_minus_F = (sum(as.numeric(Hit) - 1 )/60)*100 - 
        (sum(as.numeric(FalseAlarm) -1)/60)*100 )
SWM2$Prisms <- relevel(SWM2$Prisms, "pre") # Needed for automatic x-axis order
SWM2
```

Should problably look at some other signal detection measures, and what has 
been used in the previous papers. For now, using those simple ones.

Plotting Hits minus false alarms:
```{r VWM_H-Fa, fig.width=12, cache=FALSE}
qplot(data = SWM2, x=Prisms, y=H_minus_F, geom="bar", stat="identity", 
        width = 0.8, ylim=c(0,100), ylab = "Hits minus false alarms") + 
        facet_wrap(~ Subject) +
        geom_abline(aes(intercept=79, slope=0), size=1, alpha=0.9) +
        geom_abline(aes(intercept=79, slope=0), size=2*8.7, alpha=0.2) +
        geom_abline(aes(intercept=89, slope=0),  size=1, alpha=0.9) +
        geom_abline(aes(intercept=89, slope=0),  size=2*6.1, alpha=0.8) +
        ggtitle("Spatial Working Memory Test") + xlab("")
```

Plotting Hits:
```{r Hits, fig.width=12, cache=FALSE}
qplot(data = SWM2, x=Prisms, y=Hits, geom="bar", stat="identity", 
        width = 0.8) + facet_wrap(~ Subject)
```

Plotting false alarms:
```{r Fa, fig.width=12, cache=FALSE}
qplot(data = SWM2, x=Prisms, y=FalseAlarms, geom="bar", stat="identity", 
        width = 0.8) + facet_wrap(~ Subject)
```

Everyone's sample mean Hits - false alarm rate increased, though only two are 
likely significant in any way. Because of the low numbers of False postivies 
(false alarms), this variable is likely unreliable -making the Hits-False alarms
metric non-ideal. Will have to look for something else in SDT.

## SWM tests
```{r}
library(dplyr)
library(tidyr)
wide <- spread(SWM2[,c(1,2,5)], Prisms, H_minus_F)
t.test(wide$pre, wide$post, paired=TRUE, alternative= "less")
summary(wide)
rm(wide)
```

As a group, the patients do improve statistically significantly (provided a 
one-sided test is used). However, as can be seen in the figures, this improvement
comes nowhere close to returning to healthy performance. 

Calculate z scores for each cell. 
```{r}
SWM2$h <- 79
SWM2$h_SD <-8.7
SWM2$rbd <- 89
SWM2$rbd_SD <- 6.1
SWM2$h_z <- abs(SWM2$H_minus_F - SWM2$h) / SWM2$h_SD
SWM2$rbd_z <- abs(SWM2$H_minus_F - SWM2$rbd) / SWM2$rbd_SD
SWM2[,c(1,2,10,11)][SWM2$Prisms=="post",]
summary(SWM2[,c(1,2,10,11)][SWM2$Prisms=="post",][SWM2$Subject != 27,])
```






## Plotting Line Bisection

This, in combination with the other neglect tests, gives an idea of who was 
neglecting, and who 

Table of means:
```{r}
ddply(LB, .(Subject, Session, Prisms), summarise, 
      PercentError = round(mean(Percent_Error),2),
      sd = round(sd(Percent_Error), 2))

```

Everything but Sj 408, session 2 looks fine. Looking at those trials:
```{r}
LB[LB$Subject=="408" & LB$Session=="2",]
```
I checked the paper records, and yes, this participant did drastically *left-shift*
their responses on many of the trials. Not sure what to make of that. Participant
did show extreme neglect on both cancellation tasks, with slight improvement post
prisms. Figure drawing was fine.



Now to plot:
```{r Line_bisection, fig.width=12, cache=FALSE}
LB2 <- ddply(LB, .(Subject, Session, Prisms), summarise, 
      PercentError = round(median(Percent_Error),2),
      sd = round(sd(Percent_Error), 2))
#LB2$Prisms <- relevel(LB2$Prisms, "post") # Needed for automatic x-axis order
LB2$Session <- as.numeric(as.character(LB2$Session))
p <- qplot(data = LB2, x=Session, y=PercentError, geom="bar", stat="identity", 
       fill=Prisms, width = 0.8) + facet_wrap(~ Subject)
p + scale_fill_brewer(type="qual", palette=3)  + 
  coord_flip() + scale_x_reverse() + geom_abline(aes(intercept=0, slope=0))
```


note on Partipant 95. Don't use session 3, as computer tasks weren't run, or
session 1 as it's old. Note that session 2 and 4 was actually pre first, they 
just got numbered backward.

Participant 163, session 3 was only partial (no SWM), so use only 4.

Use most recent pre prisms session

```{r}
LB2$Session <- as.numeric(LB2$Session)
s <- LB2$Subject == "95" & ( LB2$Session == 2 | LB2$Session ==4)
s <- s | LB2$Subject == "27" & LB2$Session > 1
s <- s | LB2$Subject == "97" & LB2$Session > 1
s <- s | LB2$Subject == "163" & ( LB2$Session == 2 | LB2$Session ==4)
s <- s | LB2$Subject == "171" & (LB2$Session > 2)
s <- s | LB2$Subject == "408"
LB2 <- LB2[s,]

LB2$Session <- as.numeric(as.character(LB2$Session))
p <- qplot(data = LB2, x=as.numeric(Prisms), y=PercentError, geom="bar", stat="identity", 
       fill=Prisms, width = 0.8) + facet_wrap(~ Subject)
p + scale_fill_brewer(type="qual", palette=3)  + 
  coord_flip() + scale_x_reverse()  +
  ylab("") + theme(axis.text.y = element_blank()) + ggtitle("Line Biasection Bias") +
  xlab("Percent of Line")+ geom_abline(aes(intercept=0, slope=0))

```

```{r}
LB3 <- spread(LB2[c(1,3,4)], Prisms, PercentError)
t.test(LB3$pre, LB3$post, paired=TRUE, alternative="greater")
t.test(LB3$pre[2:6], LB3$post[2:6], paired=TRUE, alternative="greater")
```

Individual:
```{r}
LB$Session <- as.numeric(LB$Session)
s <- LB$Subject == "95" & ( LB$Session == 2 | LB$Session ==4)
s <- s | LB$Subject == "27" & LB$Session > 1
s <- s | LB$Subject == "97" & LB$Session > 1
s <- s | LB$Subject == "163" & ( LB$Session == 2 | LB$Session ==4)
s <- s | LB$Subject == "171" & (LB$Session > 2)
s <- s | LB$Subject == "408"
LB4 <- LB[s,]
for(i in levels(LB$Subject)) {
  print(i)
  print(t.test(LB4$Percent_Error[LB4$Subject == i] ~ LB4$Prisms[LB4$Subject == i]))
  }


```


## Now the other neurological tests

### Star
```{r Star, fig.width=12, cache=FALSE}
NT$Star_L_Omissions <- -(NT$Star_L_Omissions)

ggplot(data = subset(NT, !is.na(Star_Prisms)), aes(x=Session, alpha=Star_Prisms )) + 
  geom_bar(data=NT, aes(y=Star_L_Omissions), stat="identity", color="grey20", fill = "red")  +
  geom_bar(data=NT, aes(y=Star_R_Omissions), stat="identity", color="grey20", fill = "blue") +
  coord_flip() + facet_wrap(~ Subject)
                
```
Looks like 3 participants don't have post prisms star data entered. Check into this.


### Bell
```{r Bell, fig.width=12, cache=FALSE}
#NT$Bell_L_omissions <- -(NT$Bell_L_omissions)
NT$Bell_L_omissions <- -(NT$Bell_L_omissions)
ggplot(data = subset(NT, !is.na(Bell_Prisms)), aes(x=Session, alpha=Bell_Prisms )) + 
  geom_bar(data=NT, aes(y=Bell_L_omissions), stat="identity", color="grey20", fill = "red")  +
  geom_bar(data=NT, aes(y=Bell_R_Omissions), stat="identity", color="grey20", fill = "blue") +
  coord_flip() + facet_wrap(~ Subject)
                
```

These figures are probably just useful for deciding categories. They are pretty
ugly. We could catagorize as Neglecting/Non-Neglecting, and/or Improved/no-improvement.
This would be simply a cutoff for calculating groups, not a statistical test.

Note: zero's don't show up on above plots.

1. Take median values for pre and post bells and stars.
2. Create table of clinical measures.

```{r}
#Select only those sessions applicable (sorry for readability)
NT2 <- NT[c(4,2,7,8,9,10,15,17,23,25,31,32),c(1,7,10,12,13)]
names(NT2) <- .(Patient, Stars, Bells, Prisms, Drawing)
NT2$Stars <- -round(NT2$Stars)
NT2$Bells <- -round(NT2$Bells)

tmp <- spread(NT2[,c(1,2,4)], Prisms, Stars)
t.test(tmp$no[2:6], tmp$yes[2:6], paired=TRUE)
print(tmp)

p1 <- ggplot(NT2, aes(x = Patient, y = Stars, fill=Prisms)) +
    geom_bar(position="dodge", stat="identity", width=0.4) +
    theme(legend.position = "none") +
    xlab("No bar shows up for zero") +
    ylab("% targets missed") + 
    ggtitle("Terrible plot of Stars data") +
    scale_y_continuous(breaks=0:20*4) +
    theme_gray()


tmp <- spread(NT2[,c(1,3,4)], Prisms, Bells)
t.test(tmp$no[2:6], tmp$yes[2:6], paired=TRUE)
print(tmp)

p2 <- ggplot(NT2, aes(x = Patient, y = Bells, fill=Prisms)) +
    geom_bar(position="dodge", stat="identity", width=0.4) +
    xlab("") +
    ylab("") + 
    ggtitle("Terrible plot of Bells data") +
    scale_y_continuous(breaks=0:20*4) +
    theme_gray()
source("multiplot.r")
multiplot(p1, p2, cols=2)

spread(NT2[,c(1,4,5)], Prisms, Drawing)
```


### Clinical Table


















